<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaboom Platformer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #1a1a2e;
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 2px solid #16213e;
        }
        #game-container {
            position: relative;
        }
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 800px;
            height: 600px;
            pointer-events: none;
            z-index: 1000;
        }
        #level-text {
            position: absolute;
            top: 20px;
            left: 30px;
            font-size: 24px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
        }
        #help-text {
            position: absolute;
            bottom: 20px;
            left: 30px;
            font-size: 16px;
            color: #ccc;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="ui-overlay">
            <div id="level-text">Уровень 1</div>
            <div id="help-text">Управление: Стрелки + Пробел</div>
        </div>
    </div>
    <script type="module">
        import kaboom from "https://unpkg.com/kaboom@2000.2.10/dist/kaboom.mjs";

        // Инициализация Kaboom
        const k = kaboom({
            width: 800,
            height: 600,
            background: [20, 20, 46],
            scale: 1,
            gravity: 1200,
            canvas: document.querySelector("#game-container").appendChild(document.createElement("canvas")),
        });

        // Константы игры
        const SPEED = 200;
        const JUMP_FORCE = 500;
        let currentLevel = 1;

        // Уровни игры
        const levels = [
            {
                map: [
                    "                    ",
                    "                    ",
                    "         =          ",
                    "                    ",
                    "    =        =      ",
                    "                    ",
                    "                  * ",
                    "====================",
                ],
                spawn: [1, 6]
            },
            {
                map: [
                    "                    ",
                    "                    ",
                    "    =    =    =     ",
                    "                    ",
                    "                    ",
                    "  =            =    ",
                    "                 *  ",
                    "==    ====   =======",
                ],
                spawn: [1, 6]
            },
            {
                map: [
                    "                    ",
                    "        =           ",
                    "                    ",
                    "      =      =      ",
                    "                    ",
                    "   =           =    ",
                    "                  * ",
                    "==              ====",
                ],
                spawn: [1, 6]
            }
        ];

        // Функция загрузки уровня
        function loadLevel(levelNum) {
            const level = levels[levelNum - 1];
            const tileSize = 40;
            
            // Создаем платформы и цели вручную из карты
            for (let row = 0; row < level.map.length; row++) {
                for (let col = 0; col < level.map[row].length; col++) {
                    const char = level.map[row][col];
                    const x = col * tileSize;
                    const y = row * tileSize;
                    
                    if (char === "=") {
                        // Платформа
                        add([
                            rect(tileSize, tileSize),
                            color(76, 209, 55),
                            pos(x, y),
                            area(),
                            solid(),
                            "platform"
                        ]);
                    } else if (char === "*") {
                        // Цель
                        add([
                            rect(30, 30),
                            color(255, 215, 0),
                            pos(x + 5, y + 5),
                            area(),
                            "goal"
                        ]);
                    }
                }
            }

            // Создаем игрока
            const player = add([
                rect(30, 30),
                color(52, 152, 219),
                pos(level.spawn[0] * tileSize + 5, level.spawn[1] * tileSize + 5),
                area(),
                body(),
                "player"
            ]);

            return player;
        }

        // Сцена игры
        scene("game", (levelNum) => {
            const player = loadLevel(levelNum);

            // Управление игроком
            onKeyDown("left", () => {
                player.move(-SPEED, 0);
            });

            onKeyDown("right", () => {
                player.move(SPEED, 0);
            });

            onKeyDown("a", () => {
                player.move(-SPEED, 0);
            });

            onKeyDown("d", () => {
                player.move(SPEED, 0);
            });

            // Прыжок
            onKeyPress("space", () => {
                console.log("Space pressed!");
                if (player.isGrounded()) {
                    player.jump(JUMP_FORCE);
                }
            });

            onKeyPress("up", () => {
                if (player.isGrounded()) {
                    player.jump(JUMP_FORCE);
                }
            });

            onKeyPress("w", () => {
                if (player.isGrounded()) {
                    player.jump(JUMP_FORCE);
                }
            });

            // Столкновение с целью
            player.onCollide("goal", () => {
                if (levelNum < levels.length) {
                    // Переход на следующий уровень
                    go("game", levelNum + 1);
                } else {
                    // Победа! Начинаем заново
                    go("win");
                }
            });

            // Падение за пределы экрана
            player.onUpdate(() => {
                if (player.pos.y > 700) {
                    go("game", levelNum); // Перезапуск уровня
                }
            });

            // UI - Обновляем HTML элементы
            document.getElementById("level-text").textContent = `Уровень ${levelNum}`;
        });

        // Сцена победы
        scene("win", () => {
            // Скрываем обычный UI
            document.getElementById("level-text").style.display = "none";
            document.getElementById("help-text").style.display = "none";
            
            // Создаем большой текст победы поверх всего
            const winDiv = document.createElement("div");
            winDiv.id = "win-screen";
            winDiv.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                color: gold;
                font-size: 32px;
                background: rgba(0, 0, 0, 0.8);
                padding: 30px;
                border-radius: 10px;
            `;
            winDiv.innerHTML = `
                <div style="margin-bottom: 20px;">Поздравляем!<br>Вы прошли все уровни!</div>
                <div style="font-size: 20px; color: #ccc;">Нажмите ПРОБЕЛ для новой игры</div>
            `;
            document.getElementById("ui-overlay").appendChild(winDiv);

            onKeyPress("space", () => {
                // Удаляем экран победы
                const winScreen = document.getElementById("win-screen");
                if (winScreen) winScreen.remove();
                
                // Показываем обычный UI
                document.getElementById("level-text").style.display = "block";
                document.getElementById("help-text").style.display = "block";
                
                go("game", 1);
            });
        });

        // Запуск игры
        go("game", 1);
    </script>
</body>
</html>

