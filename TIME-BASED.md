# Time-Based система

## Проблема: зависимость от FPS

**Раньше:** Скорость игры зависела от частоты кадров (FPS):
- На 144 FPS игра работала быстрее
- На 60 FPS игра работала медленнее
- Непостоянная скорость на разных устройствах

**Сейчас:** Скорость игры привязана ко времени, не к FPS:
- ✅ Одинаковая скорость на любом FPS
- ✅ Плавная анимация независимо от производительности
- ✅ Предсказуемое поведение

## Как это работает

### Delta Time (dt)

`k.dt()` возвращает время в секундах с последнего кадра:
- 60 FPS → dt ≈ 0.0166 сек (1/60)
- 144 FPS → dt ≈ 0.0069 сек (1/144)
- 30 FPS → dt ≈ 0.0333 сек (1/30)

### Автоматическая обработка в Kaplay

Kaplay автоматически умножает на `dt()` для:
- `player.move(speed, 0)` - движение
- `k.setGravity(value)` - гравитация
- `body()` компонент - физика

**Пример:**
```javascript
const MOVE_SPEED = 450 // 450 пикселей в секунду

k.onKeyDown("right", () => {
  player.move(MOVE_SPEED, 0) // Kaplay автоматически: MOVE_SPEED * dt()
})
```

### Ручная обработка для анимаций

Для кастомных таймеров используем `k.dt()` явно:

```javascript
// ❌ НЕПРАВИЛЬНО (зависит от FPS):
player.runTimer += 1
if (player.runTimer > 2.4) { ... } // 2.4 кадра при 60 FPS

// ✅ ПРАВИЛЬНО (независимо от FPS):
player.runTimer += k.dt()
if (player.runTimer > 0.04) { ... } // 0.04 секунды = 25 FPS анимации
```

## Константы в level1.js

```javascript
const MOVE_SPEED = 450        // Скорость движения: 450 px/s
const JUMP_FORCE = 800        // Сила прыжка: 800 px/s
const GRAVITY = 2200          // Гравитация: 2200 px/s²
const RUN_ANIM_SPEED = 0.04   // Анимация: меняет кадр каждые 0.04 сек (25 FPS)
```

**Все значения в пикселях в секунду (px/s) или секундах!**

## Примеры использования

### 1. Движение (автоматическое)

```javascript
k.onKeyDown("right", () => {
  player.move(MOVE_SPEED, 0) // 450 px/s автоматически
})
```

### 2. Анимация (ручное)

```javascript
k.onUpdate(() => {
  player.runTimer += k.dt() // Увеличиваем на время кадра
  
  if (player.runTimer > RUN_ANIM_SPEED) { // Прошло 0.04 секунды?
    player.runFrame = (player.runFrame + 1) % 6
    player.runTimer = 0
  }
})
```

### 3. Глаза героя (таймер)

```javascript
player.eyeTimer += k.dt()

if (player.eyeTimer > k.rand(1.5, 3.5)) { // 1.5-3.5 секунд
  player.targetEyeX = k.choose([-1, 0, 1])
  player.eyeTimer = 0
}
```

## Проверка независимости от FPS

### До изменений:
- 144 FPS: герой бежит быстро
- 60 FPS: герой бежит медленно
- Анимация дёргается

### После изменений:
- 144 FPS: герой бежит нормально (плавно)
- 60 FPS: герой бежит нормально (чуть менее плавно)
- 30 FPS: герой бежит нормально (заметно менее плавно)

**Скорость движения одинаковая, меняется только плавность отображения!**

## Отладка

### Debug режим (F1):
```
Pos: 640, 460
Vel: 450, -200    ← Скорость в px/s
Can Jump: true
```

### FPS мониторинг (добавить в level1.js):
```javascript
k.onUpdate(() => {
  const fps = Math.round(1 / k.dt())
  debugText.text += `\nFPS: ${fps}`
})
```

## Важные правила

✅ **ДА:**
- Используй `k.dt()` для всех таймеров
- Измеряй скорость в px/s (пиксели в секунду)
- Измеряй время в секундах (не в кадрах)

❌ **НЕТ:**
- Не используй счётчики кадров (`frame++`)
- Не используй фиксированные числа для задержек
- Не предполагай конкретный FPS

## Дополнительно

### Фиксированный timestep (если нужно)

Для детерминированной физики можно добавить:
```javascript
const k = kaplay({
  // ... другие опции
  maxFPS: 60 // Ограничить максимальный FPS
})
```

**Внимание:** Это ограничит плавность на мониторах > 60Hz!

### Lerp для плавности

Для плавных переходов используй `k.lerp()`:
```javascript
// Плавное движение глаз
player.eyeOffsetX = k.lerp(
  player.eyeOffsetX, 
  player.targetEyeX, 
  0.1 // 10% в сторону цели каждый кадр (независимо от FPS!)
)
```

Это автоматически корректируется на `dt()` внутри Kaplay.

